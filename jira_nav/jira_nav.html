<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JiraNav</title>
    <link rel="stylesheet" href="./tareasJira.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">

    <style>
        * {
    margin: 0px;
    padding: 0px;
}

.contenedor_flex {
    display: flex;
    flex-direction: column;
    align-content: space-between;
    flex-wrap: wrap;
    justify-content: space-around;
    margin-bottom: 10px;
    background-color: #ecedee;
    width: 100%
}

h4 {
    text-align: center;
    background-color: #ecedee;
    margin-bottom: 0px;
}

.subcontenedor_flex1 {
    display: flex;
    flex-direction: row;
    justify-content: space-around;
    background-color: #ecedee;
    margin-top: 1rem;
    width: inherit;
}

.box {
    margin-right: 1rem;
}

.subcontenedor_flex2 {
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: flex-start;
    align-content: center;
    background-color:  #ecedee;
    margin-top: 1rem;
    border-top: solid 2px black;
    padding-top: 1rem;
}

.subcontenedor_flex4 {
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: space-around;
    align-content: center;
    background-color:  #ecedee;
    margin-top: 1rem;
}

.subcontenedor_flex5 {
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: space-between;
    align-content: center;
    background-color:  #ecedee;
    margin-top: 1rem;
    margin-left: 3rem;
    margin-right: 4rem;
}

.subcontenedor_flex2 > * {
    margin-left: 3rem;
}

.subcontenedor_flex4 > h6 {
    justify-items: auto;
}

.div_form {
    padding-left: 10px;
    margin-top: 10px;
    background-color:  #ecedee;
}

h5, h6 {
    background-color:  #ecedee;
}

label {
    background-color:  #ecedee;
}

#div_button {
    align-self: flex-end;
    justify-self: flex-start;
}

#form1 {
    justify-self: flex-end;
}

.headers:hover {
    color: blueviolet;
}

.key_class:hover {
    color: blueviolet;
}

#div_show {
    width: 80%;
    height: auto;
    background-color: beige;
    position: absolute;
    top: 10%;
    left: 10%;
    border: 2px black solid;
    border-radius: 20px;
    padding: 10px;
}

#div_show img {
    align-self: flex-end;
}

.titulo_issue {
    font-size: 20px;
    font-weight: bold;
    background-color: beige;
}

.texto_issue {
    background-color: beige;
}
    </style>

</head>
<body>

    <div class="contenedor_flex" id="main_div">

        <h4>Navegador de Incidencias Jira</h4>

        <div class="subcontenedor_flex4">
            
            <div>
                <h6>Stream</h6>
                <div>
                    <input type="text" id="filtro_project" name="filtro_project" class="text" title="Ingresá acrónimo de un equipo. Si no ingresás nada, busca en EASCGS y EASGNO." placeholder="ej. EASCGS">
                </div>
            </div>
            <div>
                <h6>Resumen</h6>
                <div>
                    <input type="text" id="filtro_summary" name="filtro_summary" class="text" title="Acotá la búsqueda, busca cadena en el campo Resumen.">
                </div>
            </div>
            <div>
                <h6>Edificio</h6>
                <div>
                    <input type="text" id="filtro_edificio" name="filtro_edificio" class="text" title="Acotá la búsqueda, busca cadena en campo Edificio.">
                </div>
            </div>
            <div>
                <h6>Responsable</h6>
                <div>
                    <input type="text" id="filtro_assignee" name="filtro_assignee" class="text" title="Acotá la búsqueda, busca cadena en campo Responsable.">
                </div>
            </div>
            <div>
                <h6>Informador</h6>
                <div>
                    <input type="text" id="filtro_reporter" name="filtro_reporter" class="text" title="Acotá la búsqueda, busca cadena en campo Informador.">
                </div>
            </div>
        </div>

        <div class="subcontenedor_flex1">
                <h6>Filtrar por Estado</h6>
                <div>
                    <input type="checkbox" id="estado1" name="estado1" class="box">
                    <label for="estado1">Activas</label><br>
                </div>

<!--                 <div>
                    <input type="checkbox" id="estado2" name="estado2" class="box">
                    <label for="estado2">Por hacer</label><br>
                </div>
                <div>
                    <input type="checkbox" id="estado3" name="estado3" class="box">
                    <label for="estado3">En Progreso</label><br>
                </div>
 -->
                <div>
                    <input type="checkbox" id="estado4" name="estado4" class="box">
                    <label for="estado4">Finalizadas</label><br>
                </div>
                <div>
                    <input type="checkbox" id="estado5" name="estado5" class="box">
                    <label for="estado5">Canceladas</label>
                </div>
                <div>
                    <input type="checkbox" id="subtareas" name="subtareas" class="box">
                    <label for="subtareas">Incluir Subtareas</label>
                </div>
        </div>

        <div class="subcontenedor_flex5">
            <h6>Filtrar por Fecha</h6>
            <div>
                <input type="checkbox" id="fecha1" name="fecha1" class="box" title="En desarrollo...">
                <label for="fecha">Fecha Necesidad Vencida</label><br>
            </div>
            <div>
                <input type="checkbox" id="fecha2" name="fecha2" class="box" title="En desarrollo...">
                <label for="fecha2">Fecha Planificada Vencida</label><br>
            </div>
            <div>
                <button id="boton_buscar" class="btn btn-primary btn-sm" onclick="buscarIncidencias()">Buscar</button>
            </div>
        </div>

        <div class="subcontenedor_flex2">
                <h6>Ver una Incidencia</h6>
                <input type="text" name="buscar1" id="buscar1" title="Ingresá una incidencia por su Key." placeholder="ej. EASCGS-688">
                <button id="buscarKey" class="btn btn-primary btn-sm" onclick="obtenerIssue(document.getElementById('buscar1').value)">Ver</button> 
        </div>

    </div>

    <div class="div_tabla">
        <p id="p_show1"></p>
    </div>

    <div id="div_show"></div>

    <script>
const BASE_URL="https://cpiweb.pythonanywhere.com/"

let pshow1= document.getElementById("p_show1")
pshow1.style.display= "None"

let divshow= document.getElementById("div_show")
divshow.style.display= "None"

/* 
let clave = prompt('Password:')

while (clave!="h0l4") {
        
    clave = prompt('Password:')

}
 */


function buscarIncidencias() {

    let project= document.getElementById("filtro_project").value
    let estado1= document.getElementById("estado1").checked
    let estado4= document.getElementById("estado4").checked
    let estado5= document.getElementById("estado5").checked
    let subtareas= document.getElementById("subtareas").checked

    if (!(estado1||estado4||estado5)) {
      alert('Tenés que elegir al menos un estado.')
    } 
    else {
      let jql_list=[]

      if (project=="") {
        jql_list.push('(project=EASCGS)')
      }
      else {
        jql_list.push('project='+project)
      }

      if (!subtareas) {
        jql_list.push('issuetype!=11766')
      }

      estado_list = []

      if (estado1) {
//        estado_list.push('status!=10001 AND status!=12553')
        estado_list.push('status!=10001 AND status!=11002')
      }
      if (estado4) {
        estado_list.push('status=10001')
      }
      if (estado5) {
        estado_list.push('status=11002')
      }

      let estado_str= estado_list[0]

      for (let i=1; i<estado_list.length; i++) {
        estado_str= estado_str + ' OR '+ estado_list[i]
      }

      estado_str = '('+estado_str+')'

      jql_list.push(estado_str)

      let jql_str = jql_list[0]

      for (let i=1; i<jql_list.length; i++) {
        jql_str= jql_str + ' AND '+ jql_list[i]
      }

      const html = encodeURIComponent(jql_str); 
      const END_POINT = "searchIssues2/" + html

      fetch(BASE_URL+END_POINT)
      .then(response => response.json())
      .then(json => mostrar(json))
      .catch(err => alert('Solicitud fallida', err));
  }
}

function mostrar (issues){

    console.log(issues[1].issues)

    let edificio= document.getElementById("filtro_edificio").value
    let responsable= document.getElementById("filtro_assignee").value
    let informador= document.getElementById("filtro_reporter").value
    let summary= document.getElementById("filtro_summary").value

    let fecha1= document.getElementById("fecha1").checked
    let fecha2= document.getElementById("fecha2").checked
    let hoy = new Date (Date.now())

    // Crear tabla
    const table1 = document.createElement("table");
    table1.setAttribute("id", "myTable1");
    table1.setAttribute("class", "table table-light table-striped");

    // Crear header
    col = ["Key","Resumen","Fecha Vencimiento","Estado"]
    let tr1 = table1.insertRow(-1);
    for (let i = 0; i < col.length; i++) {
        let th1 = document.createElement("th");
        th1.innerHTML = col[i];
        th1.setAttribute ("onclick", `sortTable(${i})`)
        th1.setAttribute ("class", "headers")
        tr1.appendChild(th1);
    }

    let fechaN
    let fechaP
    let sum
    let edif
    let resp
    let inf
    let contador=0
    let total=0

    // agregar datos del JSON como filas
    for (let i = 0; i < issues.length; i++) {
      for (let j = 0; j < issues[i].issues.length; j++) {
          
          total= total +1

          try {
            sum= ((issues[i].issues[j].fields.summary).toLowerCase()).includes((summary).toLowerCase()) || (summary=="")
          } catch {
            if (summary=="") {
              sum=true}
            else {
              sum=false
            }
          }

          try {
            edif= ((issues[i].issues[j].fields.customfield_13399.value).toLowerCase()).includes((edificio).toLowerCase()) || (edificio=="")
          } catch {
            if (edificio=="") {
              edif=true}
            else {
              edif=false
            }
          }
          try {
            resp= ((issues[i].issues[j].fields.assignee.displayName).toLowerCase()).includes((responsable).toLowerCase()) || (responsable=="")
          } catch {
            if (responsable=="") {
              resp=true}
            else {
              resp=false
            }
          }
          try {
            inf= ((issues[i].issues[j].fields.reporter.displayName).toLowerCase()).includes((informador).toLowerCase()) || (informador=="")
          } catch {
            if (informador=="") {
              inf=true}
            else {
              inf=false
            }
          }
          try{
            fechaN= ((new Date((issues[i].issues[j].fields.duedate)+'T15:00:00Z') < hoy) && fecha1) || !fecha1
          } catch {
            fechaN= false
          }
          try{
            fechaP= ((new Date((issues[i].issues[j].fields.customfield_12174)+'T15:00:00Z') < hoy) && fecha2) || !fecha2
          } catch {
            fechaP= false
          }

          if (sum && edif && resp && fechaN && fechaP && inf) {
              contador=contador+1
              tr1 = table1.insertRow(-1);
              let celda = tr1.insertCell(-1)
              celda.innerHTML = issues[i].issues[j].key
              celda.setAttribute("id",`${issues[i].issues[j].key}`)
              celda.setAttribute("class","key_class")
              celda.setAttribute("onclick","obtenerIssue(this.id)")
              tr1.insertCell(-1).innerHTML = issues[i].issues[j].fields.summary
              tr1.insertCell(-1).innerHTML = issues[i].issues[j].fields.duedate
              tr1.insertCell(-1).innerHTML = issues[i].issues[j].fields.status.name
          }
      }
    }

    alert('Se encontraron ' + contador + ' registros ('+ total + ')')

    // sumar la tabla creada al contenedor
    pshow1.innerHTML = "";
    pshow1.appendChild(table1);
    pshow1.style.display= "block"

}

function obtenerIssue(issue) {

    const END_POINT = "getIssue/"+issue

    fetch(BASE_URL+END_POINT)
    .then(response => response.json())
    .then(json => mostrarIssue(json))
    .catch(err => alert('Solicitud fallida', err));

}

function mostrarIssue (issue){

    let divshow= document.getElementById("div_show")
    divshow.style.display= "flex"
    divshow.style.flexDirection= "column"
    divshow.scrollIntoView()

    let icono= document.createElement("img")
    icono.setAttribute("src","https://cpiweb.github.io/jira/close.svg")
    icono.setAttribute("width","20 rem")
    icono.setAttribute("onclick","borrarHijos()")
    divshow.appendChild(icono)

    let tarea = document.createElement("p")
    tarea.setAttribute ("class", "titulo_issue")
    tarea.innerHTML = issue.key + " / " + issue.fields.summary
    divshow.appendChild(tarea)

    let responsable = document.createElement("p")
    responsable.setAttribute ("class", "texto_issue")
    try {
      responsable.innerHTML = "Responsable: " + issue.fields.assignee.displayName
    } catch {
      responsable.innerHTML = "Responsable: No asignado"
    }
    divshow.appendChild(responsable)

    let informador = document.createElement("p")
    informador.setAttribute ("class", "texto_issue")
    informador.innerHTML = "Informador: " + issue.fields.reporter.displayName
    divshow.appendChild(informador)

    let fecha_creacion = document.createElement("p")
    fecha_creacion.setAttribute ("class", "texto_issue")
    fecha_creacion.innerHTML = "Creada: " + issue.fields.customfield_11282
    divshow.appendChild(fecha_creacion)

    let fecha_necesidad = document.createElement("p")
    fecha_necesidad.setAttribute ("class", "texto_issue")
    fecha_necesidad.innerHTML = "Fecha Vencimiento: " + issue.fields.duedate
    divshow.appendChild(fecha_necesidad)

    let fecha_planificada = document.createElement("p")
    fecha_planificada.setAttribute ("class", "texto_issue")
    fecha_planificada.innerHTML = "Fecha Planificada: " + issue.fields.customfield_12174
    divshow.appendChild(fecha_planificada)

    let edificio = document.createElement("p")
    edificio.setAttribute ("class", "texto_issue")
    try{
      edificio.innerHTML = "Edificio: " + issue.fields.customfield_13399.value
    } catch {
      edificio.innerHTML = "Edificio: No informado"
    }
    divshow.appendChild(edificio)

    let pep = document.createElement("p")
    pep.setAttribute ("class", "texto_issue")
    pep.innerHTML = "PEP: " + issue.fields.customfield_13414
    divshow.appendChild(pep)

    let padre = document.createElement("p")
    padre.setAttribute ("class", "texto_issue")
    try{
      padre.innerHTML = "Tarea Padre: " + issue.fields.parent.key + " - " + issue.fields.parent.fields.summary
    } catch {
      padre.innerHTML = "Tarea Padre: No Tiene"
    }
    divshow.appendChild(padre)

    let boton = document.createElement("button")
    boton.setAttribute ("class", "btn btn-primary")
    boton.setAttribute ("onclick",`openURL('${issue.key}')`)
    boton.innerHTML = "Abrir en Jira"
    divshow.appendChild(boton)
    
  }

function sortTable(n) {
    var table,
      rows,
      switching,
      i,
      x,
      y,
      shouldSwitch,
      dir,
      switchcount = 0;
    table = document.getElementById("myTable1");
    switching = true;
    //Set the sorting direction to ascending:
    dir = "asc";
    /*Make a loop that will continue until
    no switching has been done:*/
    while (switching) {
      //start by saying: no switching is done:
      switching = false;
      rows = table.getElementsByTagName("TR");
      /*Loop through all table rows (except the
      first, which contains table headers):*/
      for (i = 1; i < rows.length - 1; i++) { //Change i=0 if you have the header th a separate table.
        //start by saying there should be no switching:
        shouldSwitch = false;
        /*Get the two elements you want to compare,
        one from current row and one from the next:*/
        x = rows[i].getElementsByTagName("TD")[n];
        y = rows[i + 1].getElementsByTagName("TD")[n];
        /*check if the two rows should switch place,
        based on the direction, asc or desc:*/
        if (dir == "asc") {
          if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
            //if so, mark as a switch and break the loop:
            shouldSwitch = true;
            break;
          }
        } else if (dir == "desc") {
          if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
            //if so, mark as a switch and break the loop:
            shouldSwitch = true;
            break;
          }
        }
      }
      if (shouldSwitch) {
        /*If a switch has been marked, make the switch
        and mark that a switch has been done:*/
        rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
        switching = true;
        //Each time a switch is done, increase this count by 1:
        switchcount++;
      } else {
        /*If no switching has been done AND the direction is "asc",
        set the direction to "desc" and run the while loop again.*/
        if (switchcount == 0 && dir == "asc") {
          dir = "desc";
          switching = true;
        }
      }
    }
  }

function borrarHijos() {
  const myNode = document.getElementById("div_show");
  while (myNode.firstChild) {
    myNode.removeChild(myNode.lastChild);
  }
  myNode.style.display="None"
}

function openURL (issue) {
  if (issue.search('EASCGS'==0)){
    url='https://tecocloud.atlassian.net/jira/software/c/projects/EASCGS/issues/'
  } else if (issue.search('EASGNO'==0)) {
    url='https://tecocloud.atlassian.net/jira/software/c/projects/EASGNO/issues/'
  }
  window.open(url+issue)
}

    </script>

</body>
</html>